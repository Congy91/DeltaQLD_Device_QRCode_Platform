{% extends "base.html" %}
{% block title %}Device {{ device.id }}{% endblock %}
{% block content %}
<div class="max-w-xl mx-auto delta-card">
    <div class="flex justify-between items-start">
        <h2 class="text-xl font-semibold">
            Device: {% if device.device_name %}{{ device.device_name }}{% else %}ID {{ device.id }}{% endif %}
        </h2>

        <div class="space-x-2 flex items-center">
            {% if logged_in %}
            <!-- QR & Delete (only for logged in users) -->
            <a class="px-3 py-1 rounded border" href="{{ url_for('preview_qr_device', device_id=device.id) }}">QR</a>
            <form method="POST" action="{{ url_for('delete_device', device_id=device.id) }}"
                onsubmit="return confirm('Are you sure you want to delete this device?');">
                <button type="submit" class="px-3 py-1 border rounded text-red-600 hover:bg-red-100">Delete</button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Device Info Table -->
    <div class="mt-4 overflow-x-auto">
        <table class="min-w-full table-auto border border-gray-300">
            <tbody>
                <tr class="bg-gray-100">
                    <td class="px-4 py-2 font-bold border-b border-gray-300">Name</td>
                    <td class="px-4 py-2 border-b border-gray-300">{{ device.device_name or "(no name)" }}</td>
                </tr>
                <tr>
                    <td class="px-4 py-2 font-bold border-b border-gray-300">Number</td>
                    <td class="px-4 py-2 border-b border-gray-300">{{ device.device_number or "(no number)" }}</td>
                </tr>
                <tr class="bg-gray-100">
                    <td class="px-4 py-2 font-bold border-b border-gray-300">Type</td>
                    <td class="px-4 py-2 border-b border-gray-300">{{ device.device_type or "(no type)" }}</td>
                </tr>
                {% if logged_in %}
                <tr>
                    <td class="px-4 py-2 font-bold border-b border-gray-300">Serial</td>
                    <td class="px-4 py-2 border-b border-gray-300">{{ device.device_serial }}</td>
                </tr>
                <tr class="bg-gray-100">
                    <td class="px-4 py-2 font-bold border-b border-gray-300">IP</td>
                    <td class="px-4 py-2 border-b border-gray-300">{{ device.device_ip }}</td>
                </tr>
                <tr>
                    <td class="px-4 py-2 font-bold border-b border-gray-300">MAC</td>
                    <td class="px-4 py-2 border-b border-gray-300">{{ device.device_mac or "(unknown)" }}</td>
                </tr>
                <tr class="bg-gray-100">
                    <td class="px-4 py-2 font-bold border-b border-gray-300">Firmware</td>
                    <td class="px-4 py-2 border-b border-gray-300">{{ device.device_firmware or "(unknown)" }}</td>
                </tr>
                <tr>
                    <td class="px-4 py-2 font-bold border-b border-gray-300">Site</td>
                    <td class="px-4 py-2 border-b border-gray-300">{{ device.site.name if device.site else "(none)" }}
                    </td>
                </tr>
                <tr class="bg-gray-100">
                    <td class="px-4 py-2 font-bold border-b border-gray-300">Location</td>
                    <td class="px-4 py-2 border-b border-gray-300">{{ device.location or "(none)" }}</td>
                </tr>
                <tr>
                    <td class="px-4 py-2 font-bold border-b border-gray-300">QR Code</td>
                    <td class="px-4 py-2 border-b border-gray-300">
                        <img src="{{ url_for('preview_qr_device', device_id=device.id) }}" alt="Device QR Preview"
                            class="w-24 h-24 border p-1 rounded" />
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if not logged_in %}
    <div class="mt-4">
        <a href="{{ url_for('login', next=request.path) }}" class="px-3 py-2 delta-btn rounded">
            Login
        </a>
    </div>
    {% endif %}

    {% if logged_in %}
    <!-- Edit Button -->
    <div class="mt-4">
        <button onclick="document.getElementById('edit-form').classList.toggle('hidden')"
            class="px-3 py-2 delta-btn rounded">Edit</button>
    </div>

    <!-- Edit Form -->
    <div id="edit-form" class="mt-4 hidden">
        <form method="POST">
            <div class="space-y-2">
                <div>
                    <label class="block text-sm">Device Name</label>
                    <input name="device_name" class="w-full px-3 py-2 border rounded"
                        value="{{ device.device_name or '' }}" />
                </div>
                <div>
                    <label class="block text-sm">Device Number</label>
                    <input name="device_number" class="w-full px-3 py-2 border rounded"
                        value="{{ device.device_number or '' }}" />
                </div>
                <div>
                    <label class="block text-sm">Device Type</label>
                    <input name="device_type" class="w-full px-3 py-2 border rounded"
                        value="{{ device.device_type or '' }}" />
                </div>
                <div>
                    <label class="block text-sm">Serial</label>
                    <input name="device_serial" class="w-full px-3 py-2 border rounded"
                        value="{{ device.device_serial or '' }}" />
                </div>
                <div>
                    <label class="block text-sm">IP</label>
                    <input name="device_ip" class="w-full px-3 py-2 border rounded"
                        value="{{ device.device_ip or '' }}" />
                </div>
                <div>
                    <label class="block text-sm">MAC</label>
                    <input name="device_mac" class="w-full px-3 py-2 border rounded"
                        value="{{ device.device_mac or '' }}" />
                </div>
                <div>
                    <label class="block text-sm">Firmware</label>
                    <input name="device_firmware" class="w-full px-3 py-2 border rounded"
                        value="{{ device.device_firmware or '' }}" />
                </div>
                <div>
                    <label class="block text-sm">Site</label>
                    <select name="site_choice" class="w-full px-3 py-2 border rounded">
                        <option value="">(none)</option>
                        {% for s in sites %}
                        <option value="{{ s.id }}" {% if device.site_id==s.id %}selected{% endif %}>{{ s.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm">Location</label>
                    <input name="location" class="w-full px-3 py-2 border rounded"
                        value="{{ device.location or '' }}" />
                </div>
                <div>
                    <label class="block text-sm">Or create new site</label>
                    <input name="new_site" class="w-full px-3 py-2 border rounded"
                        placeholder="New site name (optional)" />
                </div>
                <div class="mt-3">
                    <button class="px-4 py-2 delta-btn rounded">Save</button>
                </div>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Contact Info -->
    <div
        class="mt-6 p-3 rounded bg-red-700 text-white flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-4">
        <div class="flex-shrink-0">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Delta Logo" class="w-24 h-12 md:w-30 md:h-16">
        </div>
        <div class="text-sm text-center md:text-left">
            <strong>Delta Building Automation</strong><br>
            U4/16 Metroplex Avenue, Murarrie, 4172<br>
            Phone: <a href="tel:1300517101" class="underline text-white">1300 517 101</a><br>
            Email: <a href="mailto:service.qld@deltaba.com.au"
                class="underline text-white">service.qld@deltaba.com.au</a>
        </div>
    </div>
</div>
{% endblock %}